<html>


<body>
    <!-- import jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <div id="main_content"></div>

    <div>
        <H1>YTClip</H1>
        <p>Clip a youtube, bitchute, rumble video source.</p>
        <!-- generate a form to take in url -->
        <input type="text" name="url" id="input_url" placeholder="Enter URL" size="80"><br>
        <!-- start_timestamp -->
        <label for="start_timestamp">Start timestamp:</label>
        <input type="text" name="start" id="start_timestamp" placeholder="0:10" size="8"><br>
        <!-- end_timestamp -->
        <label for="end_timestamp">End timestamp:</label>
        <input type="text" name="end" id="end_timestamp" placeholder="0:32" size="8"><br>
        <input type="submit" value="Submit" id="submit_button">
    </div>

    <script>
        // function to download large binary data
        function download_url_as_binary(url, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'arraybuffer';
            xhr.onload = function (e) {
                if (this.status == 200) {
                    callback(this.response);
                }
            };
            xhr.send();
        }
        const dom = document.getElementById("main_content");
        function runLoop(token) {
            jQuery.get("/clip/status/" + token, function (msg) {
                dom.innerText = msg;
                if (msg == "error aborted") {
                    return;
                }
                if (msg == "ready for download") {
                    download_url_as_binary("/clip/download/" + token, function (data) {
                        var blob = new Blob([data], {
                            type: "video/mp4"
                        });
                        var url = URL.createObjectURL(blob);
                        var a = document.createElement("a");
                        a.href = url;
                        a.download = "clip.mp4";
                        a.click();
                    });
                    return;
                }
                setTimeout(function () { runLoop(token); }, 1000);
            });
        }

        document.getElementById("submit_button").onclick = function () {
            var url = document.getElementsByName("url")[0].value;
            var start = document.getElementsByName("start")[0].value;
            var end = document.getElementsByName("end")[0].value;

            // validate that the url is valid using a regex
            var regex = /(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g;
            if (!regex.test(url)) {
                alert("Invalid URL");
                return;
            }
            jQuery.post("/clip", {
                url: url,
                start: start,
                end: end
            }, function (msg) {
                runLoop(msg);
            });
        };
    </script>




</body>

</html>